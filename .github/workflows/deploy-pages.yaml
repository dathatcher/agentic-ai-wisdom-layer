name: Upload Build Summary (ZIP-based)

on:
  workflow_run:
    workflows: ["Build and Push Wisdom Layer Image"]
    types:
      - completed

jobs:
  build-summary:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
    - name: ‚¨áÔ∏è Checkout repo
      uses: actions/checkout@v3

    - name: üìÑ Generate enhanced HTML summary
      run: |
       mkdir -p dashboard

        # Extract scan stats
        TOTAL_VULNS=$(jq '[.Results[].Vulnerabilities[]] | length' trivy-vuln-scan.json)
        CRITICAL_COUNT=$(jq '[.Results[].Vulnerabilities[] | select(.Severity == "CRITICAL")] | length' trivy-vuln-scan.json)
        HIGH_COUNT=$(jq '[.Results[].Vulnerabilities[] | select(.Severity == "HIGH")] | length' trivy-vuln-scan.json)
        COMPONENT_COUNT=$(jq '.components | length' trivy-sbom.cdx.json)

        # Build HTML
        cat <<EOF > dashboard/index.html
        <!DOCTYPE html>
        <html>
        <head>
          <title>Wisdom Layer Build Summary</title>
          <style>
            body { font-family: Arial; }
            h1 { color: #333; }
            ul { line-height: 1.6; }
          </style>
        </head>
        <body>
          <h1>Build Summary: wisdom-${{ github.run_id }}</h1>
          <p><strong>View Build:</strong> <a href="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}">GitHub Actions Run</a></p>

          <h2>üõ°Ô∏è Vulnerability Scan</h2>
          <ul>
            <li>Total Vulnerabilities: <strong>$TOTAL_VULNS</strong></li>
            <li>CRITICAL: <strong>$CRITICAL_COUNT</strong></li>
            <li>HIGH: <strong>$HIGH_COUNT</strong></li>
          </ul>

          <h2>üì¶ SBOM Summary</h2>
          <ul>
            <li>Components Listed: <strong>$COMPONENT_COUNT</strong></li>
          </ul>

          <h2>üìÅ Attached Files</h2>
          <ul>
            <li>trivy-vuln-scan.json</li>
            <li>trivy-vuln-scan.csv</li>
            <li>trivy-sbom.cdx.json</li>
            <li>trivy-sbom.cdx.csv</li>
          </ul>
        </body>
        </html>
        EOF


    - name: üì¶ Copy scan results to dashboard folder
      run: |
        cp trivy-*.json dashboard/ || true
        cp trivy-*.csv dashboard/ || true

    - name: üì§ Upload summary and scans as artifact ZIP
      uses: actions/upload-artifact@v4
      with:
        name: build-results-wisdom-${{ github.run_id }}
        path: dashboard
        if-no-files-found: error
