name: Upload Build Summary (ZIP-based)

on:
  workflow_run:
    workflows: ["Build and Push Wisdom Layer Image"]
    types:
      - completed

jobs:
  build-summary:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
    - name: ⬇️ Checkout repo
      uses: actions/checkout@v3

    - name: 📄 Generate static HTML summary
      run: |
        mkdir -p dashboard
        cat <<EOF > dashboard/index.html
        <!DOCTYPE html>
        <html>
        <head><title>Wisdom Layer Build Summary</title></head>
        <body>
          <h1>Build Summary</h1>
          <p><strong>Build:</strong> wisdom-${{ github.run_id }}</p>
          <p><strong>View Build:</strong> <a href="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}">GitHub Actions Run</a></p>
          <ul>
            <li>trivy-vuln-scan.json</li>
            <li>trivy-vuln-scan.csv</li>
            <li>trivy-sbom.cdx.json</li>
            <li>trivy-sbom.cdx.csv</li>
          </ul>
        </body>
        </html>
        EOF

    - name: 📦 Copy scan results to dashboard folder
      run: |
        cp trivy-*.json dashboard/ || true
        cp trivy-*.csv dashboard/ || true

    - name: 📤 Upload summary and scans as artifact ZIP
      uses: actions/upload-artifact@v4
      with:
        name: build-results-wisdom-${{ github.run_id }}
        path: dashboard
        if-no-files-found: error
