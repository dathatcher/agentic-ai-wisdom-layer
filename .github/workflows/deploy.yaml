name: Deploy Wisdom Layer from GHCR

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Enter the version to deploy (e.g., v2)'
        required: true

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: ðŸš€ SSH and Deploy to EC2
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USER }}
        key: ${{ secrets.SSH_KEY }}
        script: |
          echo "ðŸ” Ensuring Docker is installed..."
          which docker || (sudo apt update && sudo apt install -y docker.io)

          echo "ðŸ” Logging into GHCR..."
          docker login ghcr.io -u dathatcher -p ${{ secrets.GHCR_PAT }}

          echo "ðŸ“„ Creating updated .env file..."
          echo "OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}" > /home/ubuntu/.env

          echo "ðŸ“¥ Pulling new image..."
          docker pull ghcr.io/dathatcher/wisdom-layer-poc:${{ github.event.inputs.version }}

          echo "ðŸ§¹ Stopping and removing old container..."
          docker stop wisdom || true
          docker rm wisdom || true
          docker rmi ghcr.io/dathatcher/wisdom-layer-poc:latest || true

          echo "ðŸš€ Running new container..."
          docker run -d \
            --env-file /home/ubuntu/.env \
            -p 8501:8501 \
            --name wisdom \
            ghcr.io/dathatcher/wisdom-layer-poc:${{ github.event.inputs.version }}

          echo "âœ… Wisdom Layer is deployed at http://${{ secrets.SSH_HOST }}:8501"
